---
title: "epicov_pre_iot"
author: "Matheus"
date: "23/08/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **Projeto EPICOV - CNAF/VNI**

```{r #Definindo os data frames, include=FALSE}
library(tidyverse)
library(readxl)
library(skimr)
options(digits = 3)
df <- read_excel("../epicov_inicial.xlsx")
## Definindo o data frame apenas com paciente que usaram VNI e/ou CNAF pré-IOT
df_pre <- filter(df, `Usou VNI pre IOT?` == "Yes" | `Usou CNAF pre IOT?` == "Yes")
## Data frame apenas com paciente que não usaram VNI/CNAF pré-IOT
df_npre <- filter(df, `Usou VNI pre IOT?` == "No" & `Usou CNAF pre IOT?` == "No")
df_nnpre <- filter(df, `Usou VNI pre IOT?` == "No" & `Usou CNAF pre IOT?` == "No" & `Suporte de O2 na chegada na UTI` != "VM")
## Data frame total com coluna de grupos
df_pre$Grupo <- c("Int")
df_npre$Grupo <- c("Controle")
df_nnpre$Grupo <- c("Controle") # Grupo controle que não chegou intubado à UTI
df_pret <- rbind(df_pre, df_npre) # Data frame com todos os paciente com coluna "Grupo"
df_prett <- rbind(df_pre, df_nnpre) # Data frame com todos os paciente que não chegaram à UTI intubados com coluna "Grupo"
```

## **Análise descritiva/exploratória**

### **Comparação idade**

#### **Idade grupo CNAF/VNI**
```{r #Análise exploratória - Idade}
as.data.frame(skim(df_pre$Idade))
```

#### **Idade grupo controle**
```{r}
as.data.frame(skim(df_npre$Idade))
```

#### **Teste de normalidade**
```{r}
#Grupo Intervenção
shapiro.test(df_pre$Idade)
shapiro.test(df_npre$Idade)
```
#### **Concluímos que ambas as amostras possuem distribuição não-paramétrica.**

#### **Comparação Idade**
```{r}
ggplot(df_pret, aes(Idade, fill=Grupo)) +
  geom_density(alpha=0.2)
wilcox.test(df_pre$Idade, df_npre$Idade)
```
#### Conclusão: Não há diferença entre ambos os grupos.

### **Comparação - Sexo**

#### **Sexo - grupo intervenção**

```{r}
as.data.frame(skim(df_pre$Sexo))
table(df_pre$Sexo)
prop.table(table(df_pre$Sexo))
ggplot(data=df_pre, aes(x=Sexo, y=(..count..)*100/sum(..count..), fill=Sexo))+
  geom_bar()
```

#### **Sexo- grupo controle**

```{r}
as.data.frame(skim(df_npre$Sexo))
table(df_npre$Sexo)
prop.table(table(df_npre$Sexo))
ggplot(data=df_npre, aes(x=Sexo, y=(..count..)*100/sum(..count..), fill=Sexo))+
  geom_bar()
```
#### **Comparação - Sexo**

```{r}
t1 <- select(df_pre, Sexo, Grupo)
t1
t2 <- select(df_npre, Sexo, Grupo)
t2
t3 <- rbind(t1, t2)
chisq.test(table(t3))
```

#### Não observamos diferença estatísticamente significativa entre ambos os grupos, porém, o valor de "p" quase atinge o limite.

### Comparação IMC

#### **IMC - Grupo CnAF/VNI**

```{r}
as.data.frame(skim(df_pre$IMC))
ggplot(data=df_pre, aes(x=IMC))+
  geom_density()
```

#### **IMC - Grupo controle**
```{r}
as.data.frame(skim(df_npre$IMC))
ggplot(data=df_npre, aes(x=IMC))+
  geom_density()
```

#### **Comparação**
```{r}
ggplot(data=df_pret, aes(x=IMC, fill=Grupo)) +
  geom_density(alpha=0.2)
shapiro.test(df_pre$IMC)
shapiro.test(df_npre$IMC)
wilcox.test(df_pre$IMC, df_npre$IMC)
```

#### **Ambos os grupos possuem distribuição não-paramétrica. Conclusão: Diferença estatísticamente significativa?!**

### **Comparação início dos sintomas - internação hospiptalar**

#### **Grupo CnAF/VNI**

```{r}
as.data.frame(skim(df_pre$`Data do início dos sintomas`))
as.data.frame(skim(df_pre$`Data de admissão hospitalar no HC`))
mean(difftime(df_pre$`Data de admissão hospitalar no HC`, df_pre$`Data do início dos sintomas`, units = "days"))
```

#### **Grupo controle**
```{r}
as.data.frame(skim(df_npre$`Data do início dos sintomas`))
as.data.frame(skim(df_npre$`Data de admissão hospitalar no HC`))
mean(difftime(df_npre$`Data de admissão hospitalar no HC`, df_npre$`Data do início dos sintomas`, units = "days"))
```


### **Início dos sintomas - Internação UTI**

#### **Grupo CnAF/VNI**

```{r}
as.data.frame(skim(df_pre$`Data do início dos sintomas`))
as.data.frame(skim(df_pre$`Data de admissão UTI`))
mean(difftime(df_pre$`Data de admissão UTI`, df_pre$`Data do início dos sintomas`, units = "days"))
```

#### Grupo controle
```{r}
as.data.frame(skim(df_npre$`Data do início dos sintomas`))
as.data.frame(skim(df_npre$`Data de admissão UTI`))
mean(difftime(df_npre$`Data de admissão UTI`, df_npre$`Data do início dos sintomas`, units = "days"))
```

### **Internação hospitalar - internação UTI**

#### **Grupo CnAF/VNI**

```{r}
as.data.frame(skim(df_pre$`Data de admissão hospitalar no HC`))
as.data.frame(skim(df_pre$`Data de admissão UTI`))
mean(difftime(df_pre$`Data de admissão UTI`, df_pre$`Data de admissão hospitalar no HC`, units = "days"))
```

#### **Grupo controle**

```{r}
as.data.frame(skim(df_npre$`Data de admissão hospitalar no HC`))
as.data.frame(skim(df_npre$`Data de admissão UTI`))
mean(difftime(df_npre$`Data de admissão UTI`, df_npre$`Data de admissão hospitalar no HC`, units = "days"))
```

### **Análise SAPS**

#### **Grupo CnAF/VNI**

```{r}
as.data.frame(skim(df_pre$`SAPS 3 da admissão`))
ggplot(data=df_pre, aes(x=`SAPS 3 da admissão`))+
  geom_density(fill="blue")
shapiro.test(df_pre$`SAPS 3 da admissão`)
```

#### **Grupo controle**
```{r}
as.data.frame(skim(df_npre$`SAPS 3 da admissão`))
ggplot(data=df_npre, aes(x=`SAPS 3 da admissão`))+
  geom_density(fill="blue")
shapiro.test(df_npre$`SAPS 3 da admissão`)
```

#### **Comparação SAPS 3**
```{r}
ggplot(data=df_pret, aes(x=`SAPS 3 da admissão`, fill=Grupo))+
  geom_density(alpha=0.2)
wilcox.test(df_pre$`SAPS 3 da admissão`, df_npre$`SAPS 3 da admissão`)
```

#### **Conclusão:**
#### - Ambos os grupos possuem distrbuição não paramétrica;
#### - O grupo intervenção possui distribuição bimodal;
#### - O grupo controle possui maior SAPS 3 na admissão, o resultado foi estatísticamente significativo, portanto, podemos concluir que o grupo controle possuía maior gravidade na admissão em UTI. Talvez porque parte desses pacientes já chegaram à UTI intubados.

#### **SAPS 3 grupo controle que não chegou intubado à UTI**
```{r}
as.data.frame(skim(df_nnpre$`SAPS 3 da admissão`))
ggplot(data=df_nnpre, aes(x=`SAPS 3 da admissão`))+
  geom_density(fill="blue")
shapiro.test(df_nnpre$`SAPS 3 da admissão`)
```

#### **Comparação grupo CnAF/VNI vs grupo controle que não chegou intubado à UTI**
```{r}
ggplot(data=df_prett, aes(x=`SAPS 3 da admissão`, fill=Grupo))+
  geom_density(alpha=0.2)
wilcox.test(df_pre$`SAPS 3 da admissão`, df_nnpre$`SAPS 3 da admissão`)
```
#### Agora podemos concluir que quando comparados apenas os paciente que não chegaram intubados à UTI, o grupo que foi tratado com CnAF/VNI possuia gravidade similar à dos pacientes do grupo controle.

## **Necessidade de intubação**

#### **Grupo CnAF/VNI**
```{r}
table(df_pre$`Teve falencia da VNI pre IOT?`)
table(df_pre$`Teve falencia do CNAF pre IOT?`)
t1 <- select(df_pre, `IRpA que precisou de VM`, Grupo)
ggplot(data=df_pre, aes(x=`IRpA que precisou de VM`, y=(..count..)*100/sum(..count..), fill=`IRpA que precisou de VM`)) +
  geom_bar() +
  ylab("Porcentagem de pacientes (%)") +
  xlab("Necessidade de intubação (Grupo CnAF/VNI)")
```

#### **Grupo Controle**

```{r}
t2 <- select(df_nnpre, `IRpA que precisou de VM`, Grupo)
ggplot(data=df_nnpre, aes(x=`IRpA que precisou de VM`, y=(..count..)*100/sum(..count..), fill=`IRpA que precisou de VM`)) +
  geom_bar()+
  ylab("Porcentagem de pacientes (%)") +
  xlab("Necessidade de intubação (Grupo controle")
```

#### **Comparação - Teste chi-quadrado**
```{r}
t3 <- rbind(t1, t2)
chisq.test(t3$Grupo, t3$`IRpA que precisou de VM`)
```


### **Desfecho UTI**

#### **Grupo CnAF/VNI**

```{r}
as.data.frame(table(df_pre$`Desfecho na UTI`))
as.data.frame(prop.table(table(df_pre$`Desfecho na UTI`)))
ggplot(data=df_pre, aes(x=`Desfecho na UTI`, y=(..count..)*100/sum(..count..), fill=`Desfecho na UTI`)) +
  geom_bar() +
  ylab("Porcentagem de pacientes (%)") +
  xlab("Desfecho UTI (CnAF/VNI)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

#### **Grupo controle**

```{r}
as.data.frame(table(df_nnpre$`Desfecho na UTI`))
as.data.frame(prop.table(table(df_nnpre$`Desfecho na UTI`)))
ggplot(data=df_nnpre, aes(x=`Desfecho na UTI`, y=(..count..)*100/sum(..count..), fill=`Desfecho na UTI`)) +
  geom_bar()+
  ylab("Porcentagem de pacientes (%)") +
  xlab("Desfecho UTI (Controle)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

#### **Comparação - Teste chi-quadrado**
```{r}
t1 <- select(df_pre, `Desfecho na UTI`, Grupo)
  
t2 <- select(df_nnpre, `Desfecho na UTI`, Grupo)

t3 <- rbind(t1, t2)
chisq.test(t3$Grupo, t3$`Desfecho na UTI`)
```

#### Consequente à maior necessidade de intubação, observamos maior número de óbitos no grupo CnAF/VNI.

### **Desfecho hospitalar**

#### **Grupo CnAF/VNI**
```{r}
as.data.frame(table(df_pre$`Desfecho Hospitalar`))
as.data.frame(prop.table(table(df_pre$`Desfecho Hospitalar`)))
ggplot(data=df_pre, aes(x=`Desfecho Hospitalar`, y=(..count..)*100/sum(..count..), fill=`Desfecho Hospitalar`)) +
  geom_bar() +
  ylab("Porcentagem de pacientes (%)") +
  xlab("Desfecho Hospitalar (CnAF/VNI)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

#### **Grupo controle**

```{r}
as.data.frame(table(df_nnpre$`Desfecho Hospitalar`))
as.data.frame(prop.table(table(df_nnpre$`Desfecho Hospitalar`)))
ggplot(data=df_nnpre, aes(x=`Desfecho Hospitalar`, y=(..count..)*100/sum(..count..), fill=`Desfecho Hospitalar`)) +
  geom_bar()+
  ylab("Porcentagem de pacientes (%)") +
  xlab("Desfecho Hospitalar (Controle)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

#### **Comparação**
```{r}
t1 <- select(df_pre, `Desfecho Hospitalar`, Grupo)
  
t2 <- select(df_nnpre, `Desfecho Hospitalar`, Grupo)

t3 <- rbind(t1, t2)
chisq.test(t3$Grupo, t3$`Desfecho Hospitalar`)
```